name: Build and Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build_macos:
        description: "Build macOS versions"
        required: true
        default: true
        type: boolean
      build_windows:
        description: "Build Windows version"
        required: true
        default: true
        type: boolean
      version:
        description: "Manual version number (optional, overrides tag version). Supports SemVer format like X.Y.Z, vX.Y.Z"
        required: false
        type: string
      skip_release:
        description: "Skip creating GitHub release (for testing)"
        required: false
        default: false
        type: boolean

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: x86_64-apple-darwin
            arch: x64
            condition: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.build_macos == 'false') }}
          - platform: macos-latest
            target: aarch64-apple-darwin
            arch: aarch64
            condition: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.build_macos == 'false') }}
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
            webview2: "with"
            condition: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.build_windows == 'false') }}
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            arch: x64
            webview2: "without"
            condition: ${{ !(github.event_name == 'workflow_dispatch' && github.event.inputs.build_windows == 'false') }}

    runs-on: ${{ matrix.platform }}
    timeout-minutes: 60
    continue-on-error: true

    steps:
      - name: Guard - skip if not needed
        if: ${{ !matrix.condition }}
        run: |
          echo "Skipping this matrix (condition=false)"
          # åªæ˜¯æ­£å¸¸é€€å‡ºï¼Œä¸å¤±è´¥
          exit 1
        shell: bash

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Print environment info
        run: |
          echo "Build macOS versions: ${{ github.event.inputs.build_macos }}"
          echo "Build Windows version: ${{ github.event.inputs.build_windows }}"
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Type: ${{ github.ref_type }}"
          echo "Platform: ${{ matrix.platform }}"
          echo "Target: ${{ matrix.target }}"
          echo "Arch: ${{ matrix.arch }}"
          echo "WebView2: ${{ matrix.webview2 || 'none' }}"
          echo "Condition: ${{ matrix.condition }}"
          

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Check Rust version
        run: rustc --version

      - name: Check Cargo version
        run: cargo --version

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: "./src-tauri -> target"

      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: Print pnpm version
        run: pnpm --version

      - name: Install frontend dependencies
        run: pnpm install

      - name: Check Tauri version
        run: pnpm tauri --version

      - name: Configure WebView2 bundling (Windows only)
        if: matrix.platform == 'windows-latest'
        run: |
          $webviewMode = if ('${{ matrix.webview2 }}' -eq 'with') { 'offlineInstaller' } else { 'downloadBootstrapper' }
          $configPath = 'src-tauri/tauri.conf.json'
          $config = Get-Content $configPath -Raw | ConvertFrom-Json
          $config.bundle.windows.webviewInstallMode.type = $webviewMode
          $config | ConvertTo-Json -Depth 10 | Set-Content $configPath
          Write-Host "Set WebView2 install mode to: $webviewMode"
          Get-Content $configPath | Select-String -Pattern "webviewInstallMode"
        shell: pwsh

      - name: Sync Program version (auto)
        if: github.event.inputs.version == ''
        run: pnpm version:sync

      - name: Sync Program version (manual)
        if: github.event.inputs.version != ''
        run: pnpm version:set ${{ github.event.inputs.version }}

      - name: Build frontend
        run: pnpm build

      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0.6
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAURI_SIGNING_PRIVATE_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_SIGNING_PRIVATE_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}
        with:
          tauriScript: pnpm tauri
          args: --target ${{ matrix.target }}
          distPath: ../dist
          projectPath: ./src-tauri



      - name: Check for update signature files
        run: |
          echo "=== æ£€æŸ¥æ›´æ–°ç­¾åæ–‡ä»¶ ==="
          echo "å½“å‰ç›®å½•: $(pwd)"
          echo "Bundle ç›®å½•: src-tauri/target/${{ matrix.target }}/release/bundle"
          echo ""
          echo "Bundle ç›®å½•å†…å®¹:"
          ls -la src-tauri/target/${{ matrix.target }}/release/bundle/
          echo ""
          echo "Update ç›®å½•:"
          if [ -d "src-tauri/target/${{ matrix.target }}/release/bundle/update" ]; then
            ls -la src-tauri/target/${{ matrix.target }}/release/bundle/update/
            echo ""
            echo "ç­¾åæ–‡ä»¶å†…å®¹:"
            find src-tauri/target/${{ matrix.target }}/release/bundle/update/ -type f -exec echo "æ–‡ä»¶: {}" \; -exec cat {} \; -exec echo ""
          else
            echo "Update ç›®å½•ä¸å­˜åœ¨"
          fi
          echo ""
          echo "æŸ¥æ‰¾æ‰€æœ‰ .sig æ–‡ä»¶:"
          find src-tauri/target/${{ matrix.target }}/release/ -name "*.sig" -exec echo "æ‰¾åˆ°: {}" \; || echo "æ²¡æœ‰æ‰¾åˆ° .sig æ–‡ä»¶"
        shell: bash

      - name: Rename build artifacts
        run: |
          # è¯»å–äº§å“åç§°
          PRODUCT_NAME=$(node -p "require('./src-tauri/tauri.conf.json').productName")
          if [ -z "$PRODUCT_NAME" ] || [ "$PRODUCT_NAME" = "undefined" ]; then
            PRODUCT_NAME="JSONæ ¼å¼åŒ–å·¥å…·"
          fi
          # è½¬ä¹‰äº§å“åç§°ä¸­çš„ç‰¹æ®Šå­—ç¬¦
          PRODUCT_NAME=$(echo "$PRODUCT_NAME" | sed 's/[^a-zA-Z0-9_.-]/_/g')
          
          # ç¡®å®šç‰ˆæœ¬å·
          VERSION="${{ github.event.inputs.version }}"
          if [ -z "$VERSION" ]; then
            VERSION="${{ github.ref_name }}"
          fi
          if [ -z "$VERSION" ]; then
            VERSION="0.0.0"
          fi
          VERSION=$(echo "$VERSION" | sed 's/^v//')
          
          cd src-tauri/target/${{ matrix.target }}/release/bundle
          
          echo "=== é‡å‘½åæ„å»ºäº§ç‰© ==="
          echo "äº§å“åç§°: $PRODUCT_NAME"
          echo "ç‰ˆæœ¬å·: $VERSION"
          echo "å¹³å°: ${{ runner.os }}"
          echo "æ¶æ„: ${{ matrix.arch }}"
          echo "WebView2: ${{ matrix.webview2 }}"
          
          if [ "${{ runner.os }}" = "macOS" ]; then
            ARCH="${{ matrix.arch }}"
            NEW_NAME="${PRODUCT_NAME}_${VERSION}-macos-${ARCH}.dmg"
            echo "DMG æ–°åç§°: $NEW_NAME"
            if ls dmg/*.dmg 1> /dev/null 2>&1; then
              mv dmg/*.dmg "$NEW_NAME"
              echo "DMG é‡å‘½åæˆåŠŸ"
              # åˆ›å»º latest ç‰ˆæœ¬å‰¯æœ¬
              LATEST_NAME="${PRODUCT_NAME}_latest-macos-${ARCH}.dmg"
              cp "$NEW_NAME" "$LATEST_NAME"
              echo "Latest DMG å‰¯æœ¬åˆ›å»ºæˆåŠŸ: $LATEST_NAME"
            else
              echo "è­¦å‘Š: æœªæ‰¾åˆ° DMG æ–‡ä»¶"
            fi
            NEW_NAME_TARGZ="${PRODUCT_NAME}_${VERSION}-macos-${ARCH}.app.tar.gz"
            echo "TAR.GZ æ–°åç§°: $NEW_NAME_TARGZ"
            if ls macos/*.tar.gz 1> /dev/null 2>&1; then
              mv macos/*.tar.gz "$NEW_NAME_TARGZ"
              echo "TAR.GZ é‡å‘½åæˆåŠŸ"
              # åˆ›å»º latest ç‰ˆæœ¬å‰¯æœ¬
              LATEST_NAME_TARGZ="${PRODUCT_NAME}_latest-macos-${ARCH}.app.tar.gz"
              cp "$NEW_NAME_TARGZ" "$LATEST_NAME_TARGZ"
              echo "Latest TAR.GZ å‰¯æœ¬åˆ›å»ºæˆåŠŸ: $LATEST_NAME_TARGZ"
            else
              echo "è­¦å‘Š: æœªæ‰¾åˆ° TAR.GZ æ–‡ä»¶"
            fi
          elif [ "${{ runner.os }}" = "Windows" ]; then
            WEBVIEW="${{ matrix.webview2 }}"
            if [ "$WEBVIEW" = "with" ]; then
              WEBVIEW="webview2"
            else
              WEBVIEW=""
            fi
            if [ -n "$WEBVIEW" ]; then
              NEW_NAME_BASE="${PRODUCT_NAME}_${VERSION}-windows-x64-${WEBVIEW}"
            else
              NEW_NAME_BASE="${PRODUCT_NAME}_${VERSION}-windows-x64"
            fi
            echo "MSI æ–°åç§°: ${NEW_NAME_BASE}.msi"
            echo "NSIS æ–°åç§°: ${NEW_NAME_BASE}.exe"
            # ç§»åŠ¨ MSI æ–‡ä»¶
            if ls msi/*.msi 1> /dev/null 2>&1; then
              mv msi/*.msi "${NEW_NAME_BASE}.msi"
              echo "MSI é‡å‘½åæˆåŠŸ"
              # åˆ›å»º latest ç‰ˆæœ¬å‰¯æœ¬
              if [ -n "$WEBVIEW" ]; then
                LATEST_NAME_BASE="${PRODUCT_NAME}_latest-windows-x64-${WEBVIEW}"
              else
                LATEST_NAME_BASE="${PRODUCT_NAME}_latest-windows-x64"
              fi
              cp "${NEW_NAME_BASE}.msi" "${LATEST_NAME_BASE}.msi"
              echo "Latest MSI å‰¯æœ¬åˆ›å»ºæˆåŠŸ: ${LATEST_NAME_BASE}.msi"
            else
              echo "è­¦å‘Š: æœªæ‰¾åˆ° MSI æ–‡ä»¶"
            fi
            # ç§»åŠ¨ NSIS æ–‡ä»¶
            if ls nsis/*.exe 1> /dev/null 2>&1; then
              mv nsis/*.exe "${NEW_NAME_BASE}.exe"
              echo "NSIS é‡å‘½åæˆåŠŸ"
              # åˆ›å»º latest ç‰ˆæœ¬å‰¯æœ¬
              if [ -n "$WEBVIEW" ]; then
                LATEST_NAME_BASE="${PRODUCT_NAME}_latest-windows-x64-${WEBVIEW}"
              else
                LATEST_NAME_BASE="${PRODUCT_NAME}_latest-windows-x64"
              fi
              cp "${NEW_NAME_BASE}.exe" "${LATEST_NAME_BASE}.exe"
              echo "Latest NSIS å‰¯æœ¬åˆ›å»ºæˆåŠŸ: ${LATEST_NAME_BASE}.exe"
            else
              echo "è­¦å‘Š: æœªæ‰¾åˆ° NSIS æ–‡ä»¶"
            fi
          fi
          
          echo "=== é‡å‘½ååçš„æ–‡ä»¶ ==="
          ls -la *.dmg *.tar.gz *.msi *.exe 2>/dev/null || echo "æ²¡æœ‰æ‰¾åˆ°é‡å‘½ååçš„æ–‡ä»¶"
        shell: bash

      - name: Show build artifacts tree
        run: |
          echo "=== ç¼–è¯‘åäº§ç‰©ç›®å½•ç»“æ„ ==="
          BUNDLE_DIR="src-tauri/target/${{ matrix.target }}/release/bundle"
          
          # æ£€æŸ¥ tree å‘½ä»¤æ˜¯å¦å­˜åœ¨
          if command -v tree &> /dev/null; then
            tree -L 3 "$BUNDLE_DIR"
          else
            # å¦‚æœæ²¡æœ‰ tree å‘½ä»¤ï¼Œä½¿ç”¨ find å‘½ä»¤æ¨¡æ‹Ÿ
            echo "tree å‘½ä»¤æœªæ‰¾åˆ°ï¼Œä½¿ç”¨ find å‘½ä»¤æ˜¾ç¤ºç›®å½•ç»“æ„:"
            find "$BUNDLE_DIR" -maxdepth 3 -print | sed -e 's/[^\/]*\//|  /g' -e 's/|  \([^|]\)/|-- \1/'
          fi
          
          echo "=== äº§ç‰©æ–‡ä»¶å¤§å° ==="
          find "$BUNDLE_DIR" -type f -name "*.dmg" -o -name "*.tar.gz" -o -name "*.msi" -o -name "*.exe" | xargs ls -lh 2>/dev/null || echo "æœªæ‰¾åˆ°äº§ç‰©æ–‡ä»¶"
        shell: bash

      - name: Upload artifacts (macOS)
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}-release
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/*.dmg
            src-tauri/target/${{ matrix.target }}/release/bundle/*.tar.gz
          if-no-files-found: error
          retention-days: 1

      - name: Upload artifacts (Windows)
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.webview2 && format('-{0}webview2', matrix.webview2) || '' }}-release
          path: |
            src-tauri/target/${{ matrix.target }}/release/bundle/*.msi
            src-tauri/target/${{ matrix.target }}/release/bundle/*.exe
          if-no-files-found: error
          retention-days: 1

      - name: Ensure signatures directory exists
        run: mkdir -p src-tauri/target/${{ matrix.target }}/release/signatures
        shell: bash

      - name: Copy signature files to specified location
        run: |
          # æŸ¥æ‰¾æ‰€æœ‰ç­¾åæ–‡ä»¶
          SIG_FILES=$(find src-tauri/target/${{ matrix.target }}/release -name "*.sig")
          SIG_COUNT=0
          for sig_file in $SIG_FILES; do
            echo "Found signature: $sig_file"
            # å¤åˆ¶åˆ°æŒ‡å®šç›®å½•
            cp "$sig_file" src-tauri/target/${{ matrix.target }}/release/signatures/
            SIG_COUNT=$((SIG_COUNT + 1))
          done
          echo "Total signatures found: $SIG_COUNT"
          echo "All signatures copied to signatures directory"
          
          # æ£€æŸ¥ç­¾åç›®å½•å†…å®¹
          echo "=== Signatures directory contents ==="
          ls -la src-tauri/target/${{ matrix.target }}/release/signatures/
          
          # å¦‚æœæ‰¾ä¸åˆ°ç­¾åæ–‡ä»¶ï¼Œå‘å‡ºè­¦å‘Šï¼ˆä½†ä¸å¤±è´¥ï¼Œå› ä¸ºå¯èƒ½ç”¨æˆ·ä¸æƒ³å¯ç”¨è‡ªåŠ¨æ›´æ–°ï¼‰
          if [ $SIG_COUNT -eq 0 ]; then
            echo "âš ï¸  WARNING: No signature files found! Auto-updater will not work."
            echo "Make sure TAURI_SIGNING_PRIVATE_KEY secret is set."
          fi
        shell: bash

      - name: Upload update signature
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.platform }}-${{ matrix.arch }}${{ matrix.webview2 && format('-{0}webview2', matrix.webview2) || '' }}-signature
          path: |
            src-tauri/target/${{ matrix.target }}/release/signatures/*
            src-tauri/target/${{ matrix.target }}/release/bundle/update/*
          if-no-files-found: warn
          retention-days: 1

  release:
    needs: build
    if: |
      (github.event_name == 'push' && github.ref_type == 'tag') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: "*release"
          merge-multiple: true

      - name: Download update signatures
        uses: actions/download-artifact@v4
        with:
          path: signatures
          pattern: "*signature"
          # æ³¨æ„ï¼šä¸è¦è®¾ç½® merge-multiple: trueï¼Œè®©æ¯ä¸ª artifact ä¸‹è½½åˆ°ç‹¬ç«‹çš„å­ç›®å½•
          # è¿™æ ·å¯ä»¥ä¿ç•™å¹³å°ä¿¡æ¯ï¼Œé¿å…ç­¾åæ–‡ä»¶æ··æ·†

      - name: Display structure of downloaded files
        run: |
          echo "=== Current Directory ==="
          pwd
          ls -la
          
          echo ""
          echo "=== Release Artifacts ==="
          if [ -d "artifacts" ]; then
            find artifacts -type f 2>/dev/null | head -50 || echo "No artifacts found"
            echo ""
            echo "Artifacts directory structure:"
            ls -laR artifacts/ 2>/dev/null | head -100
          else
            echo "âŒ artifacts directory does not exist!"
          fi
          
          echo ""
          echo "=== Signatures Directory ==="
          if [ -d "signatures" ]; then
            echo "Signatures directory exists"
            echo ""
            echo "Directory structure:"
            find signatures -type d 2>/dev/null | head -30
            echo ""
            echo "All files:"
            find signatures -type f 2>/dev/null | head -50
            echo ""
            echo "Detailed listing:"
            ls -laR signatures/ 2>/dev/null | head -150
          else
            echo "âŒ signatures directory does not exist!"
          fi

      - name: Collect file sizes
        id: collect_sizes
        run: |
          echo "=== æ”¶é›†æ„å»ºäº§ç‰©æ–‡ä»¶å¤§å° ==="
          FILE_SIZES=""
          
          # æŸ¥æ‰¾æ‰€æœ‰æ„å»ºäº§ç‰©å¹¶è®°å½•å¤§å°
          for file in $(find artifacts -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.msi" -o -name "*.exe" \) 2>/dev/null); do
            filename=$(basename "$file")
            size=$(stat -c%s "$file" 2>/dev/null || stat -f%z "$file" 2>/dev/null)
            echo "  $filename: $size bytes"
            
            if [ -n "$FILE_SIZES" ]; then
              FILE_SIZES="${FILE_SIZES},"
            fi
            FILE_SIZES="${FILE_SIZES}${filename}:${size}"
          done
          
          echo ""
          echo "æ–‡ä»¶å¤§å°ä¿¡æ¯: $FILE_SIZES"
          
          # è¾“å‡ºåˆ°ç¯å¢ƒå˜é‡
          echo "FILE_SIZES=$FILE_SIZES" >> $GITHUB_ENV
          echo "file_sizes=$FILE_SIZES" >> $GITHUB_OUTPUT

      - name: Generate update manifest
        id: generate_manifest
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
          FILE_SIZES: ${{ steps.collect_sizes.outputs.file_sizes }}
        run: |
          node .github/workflows/scripts/generate-manifest.js

      - name: Create Release
        if: github.event_name == 'push' && github.ref_type == 'tag'
        uses: softprops/action-gh-release@v2
        with:
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.exe
            latest-update.json
          generate_release_notes: true
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Manual Release (Testing)
        if: github.event_name == 'workflow_dispatch' && github.event.inputs.skip_release == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.generate_manifest.outputs.version }}
          name: Release ${{ steps.generate_manifest.outputs.version }}
          files: |
            artifacts/**/*.dmg
            artifacts/**/*.tar.gz
            artifacts/**/*.msi
            artifacts/**/*.exe
            latest-update.json
          generate_release_notes: false
          draft: true
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Sync Release to Gitee
        if: github.event.inputs.skip_release == 'false' || github.event_name == 'push'
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_OWNER: scorpionfree98
          GITEE_REPO: json_reader
          TAG_NAME: ${{ github.ref_name || steps.generate_manifest.outputs.version }}
        run: |
          echo "=== åŒæ­¥ Release åˆ° Gitee ==="
          echo "Tag: $TAG_NAME"

          # åˆ é™¤æ‰€æœ‰æ—§çš„ Gitee Release
          echo ""
          echo "=== åˆ é™¤æ‰€æœ‰æ—§çš„ Gitee Release ==="
          RELEASES_LIST=$(curl -s "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases?access_token=${GITEE_TOKEN}&per_page=100")
          RELEASE_IDS=$(echo "$RELEASES_LIST" | jq -r '.[].id')

          if [ -n "$RELEASE_IDS" ]; then
            for OLD_RELEASE_ID in $RELEASE_IDS; do
              echo "åˆ é™¤æ—§ Release ID: $OLD_RELEASE_ID"
              DELETE_RESPONSE=$(curl -s -X DELETE "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${OLD_RELEASE_ID}?access_token=${GITEE_TOKEN}")
              if [ -z "$DELETE_RESPONSE" ]; then
                echo "âœ… å·²åˆ é™¤ Release ID: $OLD_RELEASE_ID"
              else
                echo "âš ï¸  åˆ é™¤ Release ID: $OLD_RELEASE_ID æ—¶è¿”å›: $DELETE_RESPONSE"
              fi
            done
          else
            echo "æ²¡æœ‰æ‰¾åˆ°æ—§çš„ Release"
          fi

          # è·å– Release ä¿¡æ¯
          RELEASE_NAME="Release $TAG_NAME"
          RELEASE_BODY="ğŸš€ JSONæ ¼å¼åŒ–å·¥å…· $TAG_NAME ç‰ˆæœ¬å‘å¸ƒ

          ## ğŸ“¦ å®‰è£…åŒ…ä¸‹è½½

          ### âœ… å·²ä¸Šä¼ è‡³ Giteeï¼ˆå›½å†…ä¸‹è½½æ›´å¿«ï¼‰

          ä»¥ä¸‹æ–‡ä»¶å·²ç›´æ¥ä¸Šä¼ è‡³ Giteeï¼Œå¯ç›´æ¥ä¸‹è½½ï¼š

          #### macOS
          - Intel èŠ¯ç‰‡ç‰ˆ (.dmg)
          - Apple Silicon èŠ¯ç‰‡ç‰ˆ (.dmg)
          - Intel èŠ¯ç‰‡ç‰ˆ (.tar.gz) 
          - Apple Silicon èŠ¯ç‰‡ç‰ˆ (.tar.gz) 

          #### Windows
          - 64ä½ å®‰è£…ç‰ˆ (.msi)
          - 64ä½ å®‰è£…ç‰ˆ ä¸å« WebView2 (.exe) 

          ### âš ï¸ éœ€è¦ä» GitHub ä¸‹è½½

          ä»¥ä¸‹æ–‡ä»¶å› è¶…è¿‡ Gitee å…è´¹ç‰ˆ 100MB é™åˆ¶ï¼Œè¯·ä» GitHub Release ä¸‹è½½ï¼š

          #### Windows
          - 64ä½ å®‰è£…ç‰ˆ å« WebView2 (.exe) - é€šå¸¸ >100MB

          > ğŸ’¡ **ä¸ºä»€ä¹ˆæœ‰å¤§å°é™åˆ¶ï¼Ÿ**
          > Gitee å…è´¹ç‰ˆå¯¹å•ä¸ªé™„ä»¶æœ‰ 100MB çš„é™åˆ¶ï¼Œè€Œ Windows å®‰è£…ç¨‹åº(.exe)é€šå¸¸åŒ…å« WebView2 è¿è¡Œæ—¶ï¼Œä½“ç§¯è¾ƒå¤§ã€‚macOS å®‰è£…åŒ…(.dmg/.tar.gz)å’Œ Windows MSI å®‰è£…åŒ…é€šå¸¸å°äº 100MBï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä¸‹è½½ã€‚

          ### ğŸ”— ä¸‹è½½åœ°å€
          - [GitHub Releaseï¼ˆå®Œæ•´ç‰ˆï¼‰](https://github.com/$GITHUB_REPOSITORY/releases/tag/$TAG_NAME)
          - [Gitee Releaseï¼ˆå›½å†…åŠ é€Ÿï¼‰](https://gitee.com/${GITEE_OWNER}/${GITEE_REPO}/releases/tag/$TAG_NAME)

          ### ğŸ“ æ›´æ–°æ—¥å¿—
          è¯¦è§ [GitHub Release](https://github.com/$GITHUB_REPOSITORY/releases/tag/$TAG_NAME)"

          # åˆ›å»ºæ–°çš„ Gitee Release
          echo ""
          echo "=== åˆ›å»ºæ–°çš„ Gitee Release ==="
          RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases" \
            -H "Content-Type: application/json" \
            -d "{
              \"access_token\": \"${GITEE_TOKEN}\",
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"${RELEASE_NAME}\",
              \"body\": $(echo "$RELEASE_BODY" | jq -Rs .),
              \"prerelease\": false,
              \"target_commitish\": \"main\"
            }")

          echo "Gitee API å“åº”:"
          echo "$RESPONSE" | jq . || echo "$RESPONSE"

          # æ£€æŸ¥æ˜¯å¦åˆ›å»ºæˆåŠŸ
          RELEASE_ID=$(echo "$RESPONSE" | jq -r '.id // empty')
          if [ -z "$RELEASE_ID" ] || [ "$RELEASE_ID" = "null" ]; then
            echo "âŒ Gitee Release åˆ›å»ºå¤±è´¥"
            exit 1
          fi

          echo "âœ… Gitee Release åˆ›å»ºæˆåŠŸï¼ID: $RELEASE_ID"
          echo "é“¾æ¥: https://gitee.com/${GITEE_OWNER}/${GITEE_REPO}/releases/tag/${TAG_NAME}"

          # ä¸Šä¼ é™„ä»¶åˆ° Gitee Release
          echo ""
          echo "=== ä¸Šä¼ é™„ä»¶åˆ° Gitee Release ==="

          # å®šä¹‰ä¸Šä¼ å‡½æ•°
          upload_file() {
            local file_path="$1"
            local file_name=$(basename "$file_path")
            local file_size=$(stat -c%s "$file_path" 2>/dev/null || stat -f%z "$file_path" 2>/dev/null)

            echo ""
            echo "ä¸Šä¼ æ–‡ä»¶: $file_name (å¤§å°: $file_size bytes)"

            # æ£€æŸ¥æ–‡ä»¶å¤§å° (100MB = 104857600 bytes)
            if [ "$file_size" -gt 104857600 ]; then
              echo "âš ï¸  æ–‡ä»¶è¶…è¿‡ 100MBï¼Œè·³è¿‡ä¸Šä¼ ï¼ˆGitee å…è´¹ç‰ˆé™åˆ¶ï¼‰"
              echo "   ç”¨æˆ·å¯ä» GitHub Release ä¸‹è½½: https://github.com/$GITHUB_REPOSITORY/releases/download/$TAG_NAME/$file_name"
              return 0
            fi

            # ä¸Šä¼ æ–‡ä»¶
            UPLOAD_RESPONSE=$(curl -s -X POST "https://gitee.com/api/v5/repos/${GITEE_OWNER}/${GITEE_REPO}/releases/${RELEASE_ID}/attach_files" \
              -H "Content-Type: multipart/form-data" \
              -F "access_token=${GITEE_TOKEN}" \
              -F "file=@${file_path}")

            if echo "$UPLOAD_RESPONSE" | jq -e '.id' > /dev/null 2>&1; then
              echo "âœ… ä¸Šä¼ æˆåŠŸ: $file_name"
            else
              echo "âŒ ä¸Šä¼ å¤±è´¥: $file_name"
              echo "å“åº”: $UPLOAD_RESPONSE"
            fi
          }

          # æŸ¥æ‰¾å¹¶ä¸Šä¼ æ‰€æœ‰æ„å»ºäº§ç‰©
          echo "æŸ¥æ‰¾æ„å»ºäº§ç‰©..."
          find artifacts -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.msi" -o -name "*.exe" \) 2>/dev/null | while read file; do
            upload_file "$file"
          done

          # ä¸Šä¼  Gitee ç‰ˆæœ¬çš„ update manifest (ä½¿ç”¨ Gitee åœ°å€)
          if [ -f "latest-update-gitee.json" ]; then
            echo ""
            echo "ä¸Šä¼  Gitee ç‰ˆæœ¬çš„ update manifest..."
            upload_file "latest-update-gitee.json"
          fi

          echo ""
          echo "=== Gitee Release åŒæ­¥å®Œæˆ ==="
          echo "é“¾æ¥: https://gitee.com/${GITEE_OWNER}/${GITEE_REPO}/releases/tag/${TAG_NAME}"